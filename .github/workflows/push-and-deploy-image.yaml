name: push-and-deploy-image
run-name:  push-and-deploy-image-to-gke 
on:
    push: 
        branches: ['main','push-and-deploy-image']
env:
      GAR_LOCATION: asia-south2
      PROJECT_ID:  nyx-ai-415316
      REGISTRY_NAME: repo-1

     
jobs:
    push-image:
         permissions:
            id-token: write
            contents: write

         runs-on: ubuntu-latest
         steps:
          - name: test
            run: echo "test is running"
          - name: Checkout
            uses: actions/checkout@v2
          - name: Google Auth
            id: auth
            uses: 'google-github-actions/auth@v2.1.2'

            with:
              project_id: ${secrets.PROJECT_ID}
              token_format: 'access_token'
              credentials_json: ${secrets.SERVICE_ACCOUNT_KEY}
          - name: Docker Auth
            id: docker-auth
            uses: 'docker/login-action@v1'
            with:
                username: 'oauth2accesstoken'
                password: '${{ steps.auth.outputs.access_token }}'
                registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'
            
          - name: Build and Push Container
            run: |-
              
              export DOCKER_IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_NAME }}/nyx-backend-python:${{ github.sha }}"
              docker build -t  $DOCKER_IMAGE ./
              docker push $DOCKER_IMAGE
         
